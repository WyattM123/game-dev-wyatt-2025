<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Edge Impulse FOMO â€“ liteRTjs</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.9/dist/tf-tflite.min.js"></script>
</head>

<body>
<h2>Edge Impulse FOMO (Float32)</h2>

<button onclick="start()">Start</button>
<br><br>
<canvas id="c" width="240" height="240"></canvas>
<video id="v" autoplay playsinline hidden></video>

<script>
let model;
const SIZE = 240;
const LABELS = ["background","pen"];

async function loadModel() {
  const url = "ei-1pen-dav-object-detection-tensorflow-lite-float32-model.4.lite";
  const r = await fetch(url);
  const buf = await r.arrayBuffer();
  model = await tflite.loadTFLiteModel(buf);
  console.log("Model loaded");
}

async function start() {
  await loadModel();

  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  v.srcObject = stream;

  requestAnimationFrame(loop);
}

async function loop() {
  const ctx = c.getContext("2d");
  ctx.drawImage(v,0,0,SIZE,SIZE);

  const input = tf.tidy(() =>
    tf.browser.fromPixels(c)
      .expandDims(0)
      .toFloat()
      .div(255)
  );

  const output = await model.invoke(input);
  drawFOMO(output, ctx);

  tf.dispose([input, output]);
  requestAnimationFrame(loop);
}

function drawFOMO(out, ctx) {
  const data = out.dataSync();
  const [_, h, w, classes] = out.shape;
  const cell = SIZE / w;

  let idx = 0;
  for (let y=0;y<h;y++) {
    for (let x=0;x<w;x++) {
      let best = 0;
      let bestC = 0;
      for (let c=0;c<classes;c++) {
        const v = data[idx++];
        if (v > best) { best=v; bestC=c; }
      }
      if (bestC>0 && best>0.5) {
        ctx.fillStyle="red";
        ctx.fillRect(x*cell,y*cell,cell,cell);
        ctx.fillStyle="white";
        ctx.fillText(LABELS[bestC],x*cell+4,y*cell+12);
      }
    }
  }
}
</script>
</body>
</html>
